var currentColor="#000000",copyFrameIndex=-1,frames=1;function postUploadCallback(a){"undefined"!=typeof a.thumb?($("#images").prepend(a.thumb),clearAll(),trackEvent("Save",a.url),postDrawAction(a.share_url),showFacebookDialog(a.share_url,a.url)):trackEvent("Error",a)}
function performUpload(){for(var a={image:null},b=-1,d=!1,c=1;c<maxFrames&&!d;c++)null==PIXEL.getFrame(c)&&(b=c-1,d=!0);PIXEL.log(["lastFrameNotNull",b]);if(0!=b){-1==b&&(b=15);for(c=0;c<b+1;c++)PIXEL.setCurrentFrame((PIXEL.getCurrentFrameId()+1)%(b+1));a.image={frames:[]};for(c=0;c<b+1;c++)a.image.frames.push(PIXEL.getFrame(c))}else a.image={frame:PIXEL.getCurrentFrame()};"undefined"!=typeof parent_id&&(a.parent=parent_id);$.ajax({url:"/upload",type:"POST",contentType:"application/json",processData:!1,
data:JSON.stringify(a),success:postUploadCallback,dataType:"json"});disable($("#upload")).unbind("click");disable($("#clear"))}function upload(){confirm("Want to save?")&&("undefined"!=typeof user_uid?performUpload():(trying_to_save=!0,$("a.popup").trigger("click")));return!1}function ctrlKey(a){return navigator.platform.match(/mac/i)?a.metaKey:a.ctrlKey}
function clearAll(){for(var a=0;a<frames;a++)PIXEL.setCurrentFrame(a),PIXEL.clearCanvas(),disable($(".frame[data-frame="+a+"]"));deactivate($(".frame.active"));activate($(".frame[data-frame=0]"));enable($(".frame[data-frame=0]"));disable($(".remove_frame"));PIXEL.setCurrentFrame(0);copyFrameIndex=-1;frames=1}function deactivate(a){return a.removeClass("active")}function activate(a){return a.addClass("active")}function disable(a){return a.addClass("disabled")}
function enable(a){return a.removeClass("disabled")}function isEnabled(a){return!a.hasClass("disabled")}function trackEvent(a,b){_gaq.push(["_trackEvent","Drawings",a,b])}
function showFacebookDialog(a,b){FB.ui({method:"feed",name:"My brand new drawing",link:a,picture:b,caption:"Check my drawing out!",description:"Do you like it?",message:"My new awesome pixel art!",actions:[{name:"Fork this drawing!",link:a+"/fork"}]},function(d){d&&d.post_id&&(trackEvent("Post",b),showFacebookRequestDialog(a,b))})}
function showFacebookRequestDialog(a,b){FB.ui({method:"apprequests",message:"Would you like to fork my new awesome pixel art?",title:"Draw pixel art with your friends",data:a},function(a){a&&a.to&&trackEvent("Request",b)})}function postDrawAction(a){FB.api("/me/drawbang:draw","post",{drawing:a},function(a){(!a||a.error)&&console&&console.log(a)})}
function getCoordinates(a){return{x:a.offsetX?a.offsetX:a.pageX-a.target.parentNode.offsetLeft,y:a.offsetY?a.offsetY:a.pageY-a.target.parentNode.offsetTop}}function mouseDownCallback(a){PIXEL.setDraw(!0);a=getCoordinates(a);PIXEL.doAction(a.x,a.y,currentColor);isEnabled($("#upload"))||(enable($("#upload")).bind("click",upload),enable($("#clear")))}function mouseMoveCallback(a){var b=getCoordinates(a);PIXEL.doAction(b.x,b.y,currentColor);a.preventDefault()}
function mouseUpCallback(){PIXEL.setDraw(!1)}
$(document).ready(function(){var a=$("#canvas canvas"),b=$(".frames canvas");if("undefined"!=typeof imageData){if(PIXEL.init(a[0],b,!production_env,imageData),1<imageData.length)for(frames=imageData.length,maxFrames==frames&&disable($(".add_frame")),1<frames&&enable($(".remove_frame")),b=1;b<frames;b++)enable($(".frame[data-frame="+b+"]"))}else PIXEL.init(a[0],b,!production_env);a.mousedown(mouseDownCallback).mousemove(mouseMoveCallback);a.bind("touchstart",mouseDownCallback).bind("touchmove",mouseMoveCallback);
$(document).mouseup(mouseUpCallback);$(document).bind("touchend",mouseUpCallback);$(document).keydown(function(a){!ctrlKey(a)&&a.shiftKey&&(currentColor="rgba(0, 0, 0, 0)",activate($(".clearPixel")))});$(document).keyup(function(a){currentColor=$(".color.active").data("color");"clearPixel"!=$(".action.selectable.active").data("action")&&deactivate($(".clearPixel"))});$("#clear").click(function(){isEnabled($("#upload"))&&confirm("Sure?")&&(clearAll(),disable($("#upload")).unbind("click"),disable($("#clear")))});
$(".action.selectable").click(function(){PIXEL.setAction($(this).data("action"));deactivate($(".action.selectable.active"));activate($(this))});$(".color").click(function(){currentColor=$(this).data("color");deactivate($(".color.active"));activate($(this))});$(document).keydown(function(a){if(ctrlKey(a)&&90==a.keyCode)return PIXEL.undo(),!1});$(".undo").click(function(){PIXEL.undo()});$(".frame").click(function(){isEnabled($(this))&&(PIXEL.setCurrentFrame($(this).data("frame")),deactivate($(".frame.active")),
activate($(this)))});$(".add_frame").click(function(){isEnabled($(this))&&(frames++,maxFrames==frames&&disable($(this)),enable($(".remove_frame")),enable($(".frame[data-frame="+(frames-1)+"]")),$(".frame.active").toggleClass("active"),$(".frame[data-frame="+(frames-1)+"]").toggleClass("active"),PIXEL.setCurrentFrame(frames-1),PIXEL.log(["add_frame",frames]))});$(".remove_frame").click(function(){PIXEL.log(["remove_frame",this]);isEnabled($(this))&&(frames--,1==frames&&disable($(this)),enable($(".add_frame")),
disable($(".frame[data-frame="+frames+"]")),$(".frame.active").toggleClass("active"),$(".frame[data-frame="+(frames-1)+"]").toggleClass("active"),PIXEL.clearCanvasAt(frames),PIXEL.removeFrame(frames),PIXEL.setCurrentFrame(frames-1),PIXEL.log(["remove_frame, done",frames]))});$(".play_stop").click(function(){$(this).hasClass("stop")?PIXEL.stop():PIXEL.play(5,function(a){deactivate($(".frame.active"));$(".frame").each(function(){$(this).data("frame")==a&&activate($(this))})});$(this).toggleClass("stop")});
$(".move_right").click(function(){PIXEL.moveRight()});$(".move_top").click(function(){PIXEL.moveTop()});$(".flip_horizontal").click(function(){PIXEL.flipHorizontal()});$(".flip_vertical").click(function(){PIXEL.flipVertical()});$(".copy").click(function(){copyFrameIndex=PIXEL.getCurrentFrameId()});$(".paste").click(function(){-1<copyFrameIndex&&copyFrameIndex<frames&&PIXEL.copyFrameAt(copyFrameIndex)});$(".rotate").click(function(){PIXEL.rotate()})});
