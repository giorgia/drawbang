var PIXEL=function(){function y(a,b){this.canvas=a;this.ctx=a.getContext("2d");this.settings=b;this.clearCanvas=function(){this.canvas.width=this.canvas.width};this.drawGrid=function(){for(var a=0.5+this.settings.pixelSize;a<this.settings.size;a+=this.settings.pixelSize)this.ctx.moveTo(a,0),this.ctx.lineTo(a,this.settings.size),this.ctx.moveTo(0,a),this.ctx.lineTo(this.settings.size,a);this.ctx.strokeStyle=this.settings.gridColor;this.ctx.stroke()};this.getDataURL=function(){return this.canvas.toDataURL("image/png")};
this.draw=function(a){this.clearCanvas();for(var b=0;b<a.length;b++)for(var d=0;d<a[b].length;d++)this.ctx.fillStyle=a[b][d],this.ctx.fillRect(b*this.settings.pixelSize,d*this.settings.pixelSize,this.settings.pixelSize,this.settings.pixelSize);this.settings.showGrid&&this.drawGrid()}}var z=!1,b=[],n=[],u=null,h=0,p=null,q=[],A=!1,v="pixel",G={pixelSize:1,size:16,gridColor:"#eeeeee",showGrid:!1},s={pixelSize:20,size:320,gridColor:"#eeeeee",showGrid:!1},g={action:[],undo:[],oldUndo:[],redo:[]},w=function(){var a=
s.size/s.pixelSize;b=[];for(var d=0;d<a;d++)b.push(Array(a));for(d=0;d<b.length;d++)for(a=0;a<b[d].length;a++)b[d][a]="rgba(0, 0, 0, 0)"},x=function(){g={action:[],undo:[],oldUndo:[],redo:[]};k()},l=function(a){z&&console.log([(new Date).toString(),a])},B=function(a){q[a].clearCanvas();h==a&&(p.clearCanvas(),n[h]=null,w(),x())},f=function(a){if("undefined"!=typeof a){for(var b=a.slice(),c=0;c<a.length;c++)b[c]=a[c].slice();return b}},C=function(a,d){var c=Math.floor(a/d);c>=b.length&&(c=b.length-
1);0>=c&&(c=0);return c},r=function(a,d,c){var e=b[a][d];return e!=c?(b[a][d]=c,k(),e):!1},D=function(a,d,c){var e="rgba(0, 0, 0, 0)"==b[a][d]?null:b[a][d];if(e!=c){var g=f(b),m=(new Date).getTime();t(a,d,e,c);l("flood fill time: "+((new Date).getTime()-m));k();return g}return!1},t=function(a,d,c,e){0<=a&&(a<b[0].length&&0<=d&&d<b.length)&&("rgba(0, 0, 0, 0)"==b[a][d]?null:b[a][d])==c&&(b[a][d]=e,t(a+1,d,c,e),t(a-1,d,c,e),t(a,d+1,c,e),t(a,d-1,c,e))},k=function(a){"undefined"==typeof a?a=b:b=f(a);
p.clearCanvas();q[h].clearCanvas();p.draw(a);q[h].draw(a)},E=function(a){l("DEPRECATED");l("Use getFrameAt(index) instead");return h==a?b:n[a]},F=function(a){l("setCurrentFrame: "+a);a!=h&&(n[h]=f(b),b=f(n[a]),"undefined"==typeof b&&(n[a]=null,w()),h=a,x(),l("setCurrentFrame - frames.length: "+n.length))};return{init:function(a,d,c,e){p=new y(a,s);for(a=0;a<d.length;a++)q[a]=new y(d[a],G);"undefined"!=typeof c?z=c:null;w();if("undefined"!=typeof e)for(b=f(e[0]),p.clearCanvas(),p.draw(e[0]),d=0;d<
e.length;d++)n[d]=f(e[d]),q[d].clearCanvas(),q[d].draw(e[d]);else null;x()},clearCanvasAt:B,clearCanvas:function(){B(h)},removeFrame:function(a){n.splice(a,1)},setDraw:function(a){A=a},setAction:function(a){v=a},doAction:function(a,b,c){if(A){var e=C(a,s.pixelSize),f=C(b,s.pixelSize);switch(v){case "pixel":var m=r(e,f,c);!1!=m&&(g.undo.push(function(){r(e,f,m)}),g.action.push(function(){r(e,f,c)}));break;case "clearPixel":m=r(e,f,"rgba(0, 0, 0, 0)");!1!=m&&(g.undo.push(function(){r(e,f,m)}),g.action.push(function(){r(e,
f,"rgba(0, 0, 0, 0)")}));break;case "fill":var h=D(e,f,c);!1!=m&&(g.undo.push(function(){k(h)}),g.action.push(function(){D(e,f,c)}));break;default:l("unknown action:"+v)}}},getHistory:function(){return g},undo:function(){if(0<g.undo.length){var a=g.undo.pop();a.call();g.redo.push(g.action.pop());g.oldUndo.push(a)}},getFrame:E,setCurrentFrame:F,getCurrentFrame:function(){return b},getCurrentFrameId:function(){return h},play:function(a,b){1<n.length&&(u=setInterval(function(){activeFrame=(h+1)%n.length;
l(["play animation","activeFrame: "+activeFrame,"currentFrame: "+h,"frames.length: "+n.length]);F(activeFrame);b(activeFrame)},1E3*(1/a)))},stop:function(){clearInterval(u);u=null},moveRight:function(){var a=f(b),d=(new Date).getTime();for(j=0;j<b[0].length;j++){var c=b[b.length-1][j];for(i=b.length-1;0<i;i--)b[i][j]=b[i-1][j];b[0][j]=c}l("move right time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},moveTop:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length;c++)b[c].push(b[c].shift());
l("move top time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},flipHorizontal:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length/2;c++)for(var e=0;e<b[c].length;e++){var h=b[c][e],m=b.length;b[c][e]=b[m-1-c][e];b[m-1-c][e]=h}l("flip vertical time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},flipVertical:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length/2;e++){var h=b[c][e],m=b[c].length;b[c][e]=b[c][m-1-
e];b[c][m-1-e]=h}l("flip vertical time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},rotate:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length;e++)b[c][e]=a[b[c].length-1-e][c];l("rotate time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},copyFrameAt:function(a){var d=f(b),c=(new Date).getTime();b=f(E(a));l("copyFrameAt "+a+": "+((new Date).getTime()-c));k();g.undo.push(function(){k(d)})},log:l}}();
