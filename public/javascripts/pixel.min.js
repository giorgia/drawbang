var PIXEL=function(){function x(a,b){this.canvas=a;this.ctx=a.getContext("2d");this.settings=b;this.clearCanvas=function(){this.canvas.width=this.canvas.width};this.drawGrid=function(){for(var a=0.5+this.settings.pixelSize;a<this.settings.size;a+=this.settings.pixelSize)this.ctx.moveTo(a,0),this.ctx.lineTo(a,this.settings.size),this.ctx.moveTo(0,a),this.ctx.lineTo(this.settings.size,a);this.ctx.strokeStyle=this.settings.gridColor;this.ctx.stroke()};this.getDataURL=function(){return this.canvas.toDataURL("image/png")};
this.draw=function(a){this.clearCanvas();for(var b=0;b<a.length;b++)for(var d=0;d<a[b].length;d++)this.ctx.fillStyle=a[b][d],this.ctx.fillRect(b*this.settings.pixelSize,d*this.settings.pixelSize,this.settings.pixelSize,this.settings.pixelSize);this.settings.showGrid&&this.drawGrid()}}var y=!1,b=[],n=[],t=null,h=0,o=null,p=[],z=!1,u="pixel",F={pixelSize:1,size:16,gridColor:"#eeeeee",showGrid:!1},r={pixelSize:20,size:320,gridColor:"#eeeeee",showGrid:!1},g={action:[],undo:[],oldUndo:[],redo:[]},v=function(){var a=
r.size/r.pixelSize;b=[];for(var d=0;d<a;d++)b.push(Array(a));for(d=0;d<b.length;d++)for(a=0;a<b[d].length;a++)b[d][a]="rgba(0, 0, 0, 0)"},w=function(){g={action:[],undo:[],oldUndo:[],redo:[]};k()},l=function(a){y&&console.log([(new Date).toString(),a])},A=function(a){p[a].clearCanvas();h==a&&(o.clearCanvas(),n[h]=null,v(),w())},f=function(a){if("undefined"!=typeof a){for(var b=a.slice(),c=0;c<a.length;c++)b[c]=a[c].slice();return b}},B=function(a,d){var c=Math.floor(a/d);c>=b.length&&(c=b.length-
1);0>=c&&(c=0);return c},q=function(a,d,c){var e=b[a][d];return e!=c?(b[a][d]=c,k(),e):!1},C=function(a,d,c){var e="rgba(0, 0, 0, 0)"==b[a][d]?null:b[a][d];if(e!=c){var g=f(b),m=(new Date).getTime();s(a,d,e,c);l("flood fill time: "+((new Date).getTime()-m));k();return g}return!1},s=function(a,d,c,e){if(0<=a&&a<b[0].length&&0<=d&&d<b.length&&("rgba(0, 0, 0, 0)"==b[a][d]?null:b[a][d])==c)b[a][d]=e,s(a+1,d,c,e),s(a-1,d,c,e),s(a,d+1,c,e),s(a,d-1,c,e)},k=function(a){"undefined"==typeof a?a=b:b=f(a);o.clearCanvas();
p[h].clearCanvas();o.draw(a);p[h].draw(a)},D=function(a){l("DEPRECATED");l("Use getFrameAt(index) instead");return h==a?b:n[a]},E=function(a){l("setCurrentFrame: "+a);a!=h&&(n[h]=f(b),b=f(n[a]),"undefined"==typeof b&&(n[a]=null,v()),h=a,w(),l("setCurrentFrame - frames.length: "+n.length))};return{init:function(a,d,c,e){o=new x(a,r);for(a=0;a<d.length;a++)p[a]=new x(d[a],F);"undefined"!=typeof c&&(y=c);v();if("undefined"!=typeof e){b=f(e[0]);o.clearCanvas();o.draw(e[0]);for(d=0;d<e.length;d++)n[d]=
f(e[d]),p[d].clearCanvas(),p[d].draw(e[d])}w()},clearCanvasAt:A,clearCanvas:function(){A(h)},removeFrame:function(a){n.splice(a,1)},setDraw:function(a){z=a},setAction:function(a){u=a},doAction:function(a,b,c){if(z){var e=B(a,r.pixelSize),f=B(b,r.pixelSize);switch(u){case "pixel":var m=q(e,f,c);!1!=m&&(g.undo.push(function(){q(e,f,m)}),g.action.push(function(){q(e,f,c)}));break;case "clearPixel":m=q(e,f,"rgba(0, 0, 0, 0)");!1!=m&&(g.undo.push(function(){q(e,f,m)}),g.action.push(function(){q(e,f,"rgba(0, 0, 0, 0)")}));
break;case "fill":var h=C(e,f,c);!1!=m&&(g.undo.push(function(){k(h)}),g.action.push(function(){C(e,f,c)}));break;default:l("unknown action:"+u)}}},getHistory:function(){return g},undo:function(){if(0<g.undo.length){var a=g.undo.pop();a.call();g.redo.push(g.action.pop());g.oldUndo.push(a)}},getFrame:D,setCurrentFrame:E,getCurrentFrame:function(){return b},getCurrentFrameId:function(){return h},play:function(a,b){1<n.length&&(t=setInterval(function(){activeFrame=(h+1)%n.length;l(["play animation",
"activeFrame: "+activeFrame,"currentFrame: "+h,"frames.length: "+n.length]);E(activeFrame);b(activeFrame)},1E3*(1/a)))},stop:function(){clearInterval(t);t=null},moveRight:function(){var a=f(b),d=(new Date).getTime();for(j=0;j<b[0].length;j++){var c=b[b.length-1][j];for(i=b.length-1;0<i;i--)b[i][j]=b[i-1][j];b[0][j]=c}l("move right time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},moveTop:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length;c++)b[c].push(b[c].shift());
l("move top time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},flipHorizontal:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length/2;c++)for(var e=0;e<b[c].length;e++){var h=b[c][e],m=b.length;b[c][e]=b[m-1-c][e];b[m-1-c][e]=h}l("flip vertical time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},flipVertical:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length/2;e++){var h=b[c][e],m=b[c].length;b[c][e]=b[c][m-1-
e];b[c][m-1-e]=h}l("flip vertical time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},rotate:function(){for(var a=f(b),d=(new Date).getTime(),c=0;c<b.length;c++)for(var e=0;e<b[c].length;e++)b[c][e]=a[b[c].length-1-e][c];l("rotate time: "+((new Date).getTime()-d));k();g.undo.push(function(){k(a)})},copyFrameAt:function(a){var d=f(b),c=(new Date).getTime();b=f(D(a));l("copyFrameAt "+a+": "+((new Date).getTime()-c));k();g.undo.push(function(){k(d)})},log:l}}();
